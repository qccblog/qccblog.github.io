(window.webpackJsonp=window.webpackJsonp||[]).push([[87],{670:function(s,a,t){"use strict";t.r(a);var n=t(17),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("在这个很多功能使用都要求 HTTPS 的浏览器环境下，一般站点使用 Caddy 配置代理真的很方便，不需要申请再手动配置 SSL 证书，更不需要考虑定期更新证书以免忘记更新导致站点访问报错。如果是想要了解怎么使用可以参考 "),t("RouterLink",{attrs:{to:"/views/blog/2022/Caddy 使用入门.html"}},[s._v("Caddy 使用入门")]),s._v("，这里主要参考 "),t("a",{attrs:{href:"https://caddyserver.com/docs/automatic-https",target:"_blank",rel:"noopener noreferrer"}},[s._v("Automatic HTTPS"),t("OutboundLink")],1),s._v(" 来聊聊怎么在各自场景下用 Caddy 给解析的域名配置 HTTPS 。")],1),s._v(" "),t("blockquote",[t("p",[s._v("Caddy is the first and only web server to use HTTPS automatically "),t("em",[s._v("and by default")]),s._v(".")])]),s._v(" "),t("p",[s._v("Caddy 默认情况下会给所有的站点配置 HTTPS，对本地地址使用的是自签名的证书，对公共 DNS 解析的域名使用 "),t("code",[s._v("ACME CA")]),s._v("（目前是 "),t("a",{attrs:{href:"https://letsencrypt.org/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Let's Encrypt"),t("OutboundLink")],1),s._v(" 和 "),t("a",{attrs:{href:"https://zerossl.com/",target:"_blank",rel:"noopener noreferrer"}},[s._v("ZeroSSL"),t("OutboundLink")],1),s._v("）提供的证书。Caddy 默认会把 HTTP 重定向到 HTTPS，更方便的一点是 Caddy 还会自动更新证书。")]),s._v(" "),t("h2",{attrs:{id:"_80-和-443-开放的时候"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_80-和-443-开放的时候"}},[s._v("#")]),s._v(" 80 和 443 开放的时候")]),s._v(" "),t("p",[s._v("这种情况下配置 HTTPS 非常简单，简单到就是不需要做任何额外的配置，只要根据需求配置好 Caddy 然后启动就会自动配置，直接访问域名就会跳转到对应的 HTTPS 站点。")]),s._v(" "),t("h2",{attrs:{id:"_80-和-443-不开放的时候"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_80-和-443-不开放的时候"}},[s._v("#")]),s._v(" 80 和 443 不开放的时候")]),s._v(" "),t("p",[s._v("如果由于某些原因不能开放 80 和 443 端口的情况下，直接按照默认配置是无法成功启用 HTTPS 的，启动的时候会给出类似下面的报错：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.finecat.site/img/2022/12/cc40b5d6d3d8c6278e683dd76d8d5ade.png",alt:"启动提示 ssl 错误",title:"启动提示ssl错误"}})]),s._v(" "),t("p",[s._v("这是因为如果要获得受信任的 TLS 证书是需要受信任的第三方机构进行验证通过的。这种验证默认情况下是访问 80/443 端口进行验证，但是由于 80/443 端口是不可访问的，就会导致验证不通过，从而造成 SSL 证书生成失败，自然也就无法使用 HTTPS 了。")]),s._v(" "),t("p",[s._v("实际上 "),t("a",{attrs:{href:"https://tools.ietf.org/html/rfc8555",target:"_blank",rel:"noopener noreferrer"}},[s._v("ACME protocol"),t("OutboundLink")],1),s._v(" 提供了三种验证方式，Caddy 默认会随机使用 "),t("code",[s._v("HTTP challenge")]),s._v(" 或者 "),t("code",[s._v("TLS-ALPN challenge")]),s._v(" 中的一种进行验证。其中 "),t("code",[s._v("HTTP challenge")]),s._v(" 是通过域名的 A/AAAA 记录找到对应的主机，然后使用 HTTP 请求通过 80 端口访问临时的加密资源，如果获取到预期的资源就会颁发证书；"),t("code",[s._v("TLS-ALPN challenge")]),s._v(" 是对主机的 443 端口访问获取资源进行校验。两者的要求就是 80 或 443 端口开放，即使 Caddy 不能监听也要能监听端口的把对应请求转发到 Caddy 的端口上。")]),s._v(" "),t("p",[s._v("因此在 80 和 443 端口不能访问的情况下，只能选择第三种 "),t("code",[s._v("DNS challenge")]),s._v("。"),t("code",[s._v("DNS challenge")]),s._v(" 就是通过 DNS 查找到域名对应的一条特殊的 "),t("code",[s._v("TXT解析记录")]),s._v("，如果其解析结果是 CA 预期的值就会颁发证书。这种验证方式不需要服务器任何开放端口，并且请求证书的服务器也不需要是公网可访问的。")]),s._v(" "),t("p",[s._v("不过由于 "),t("code",[s._v("DNS challenge")]),s._v(" 需要配置域名的解析，所以需要提供一些配置来让 Caddy 操作对应 DNS 服务商提供 API 来设置和清除验证用的特殊 "),t("code",[s._v("TXT解析记录")]),s._v("。Caddy 2 使用 "),t("a",{attrs:{href:"https://caddy.community/t/writing-new-dns-provider-modules-for-caddy/7786",target:"_blank",rel:"noopener noreferrer"}},[s._v("新的和改进的 DNS 提供者接口"),t("OutboundLink")],1),s._v(" 处理 ACME DNS challenge。")]),s._v(" "),t("h3",{attrs:{id:"获取带有-dns-服务商插件的-caddy"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#获取带有-dns-服务商插件的-caddy"}},[s._v("#")]),s._v(" 获取带有 DNS 服务商插件的 Caddy")]),s._v(" "),t("p",[s._v("首先要获取一个安装了对应 DNS 服务商插件的 Caddy，有几种常用的方法可以获取：")]),s._v(" "),t("h4",{attrs:{id:"方法一"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#方法一"}},[s._v("#")]),s._v(" 方法一")]),s._v(" "),t("ul",[t("li",[s._v("进入 "),t("a",{attrs:{href:"https://caddyserver.com/download",target:"_blank",rel:"noopener noreferrer"}},[s._v("Caddy 下载页面"),t("OutboundLink")],1)]),s._v(" "),t("li",[s._v("搜索 ( dns.providers.) 或对应服务商名字，找到对应的 DNS 服务商，点击选中")]),s._v(" "),t("li",[s._v("下载添加了选中模块的 Caddy")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.finecat.site/img/2022/12/78baa38bd4d1987e6dfdb99667e5efc6.png",alt:"Caddy 下载",title:"Caddy 下载"}})]),s._v(" "),t("p",[s._v("这种方法相对比较简单，只要找到对应插件添加后下载即可。只是下载的时候需要注意选择合适的平台即可。")]),s._v(" "),t("h4",{attrs:{id:"方法二"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#方法二"}},[s._v("#")]),s._v(" 方法二")]),s._v(" "),t("ul",[t("li",[s._v("在 "),t("a",{attrs:{href:"https://github.com/caddy-dns",target:"_blank",rel:"noopener noreferrer"}},[s._v("caddy-dns 存储库"),t("OutboundLink")],1),s._v(" 中找到对应 DNS 服务商")]),s._v(" "),t("li",[t("a",{attrs:{href:"https://caddyserver.com/docs/build#xcaddy",target:"_blank",rel:"noopener noreferrer"}},[s._v("使用插入的 DNS 提供商构建 caddy"),t("OutboundLink")],1)])]),s._v(" "),t("p",[s._v("---shell\nxcaddy build --with github.com/caddy-dns/REPOSITORY")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n这种方法相对比较复杂，需要安装 xcaddy 以及对应环境等，适合高阶用户操作。\n\n#### 方法三\n\n除了上述两种方法外还可以使用官方提供的 docker 进行操作。后面的例子是基于官方 docker 加上要安装的插件构建想要的 Caddy。\n\n```shell\nFROM caddy:2.6.2-builder AS builder\n\nRUN xcaddy build \\\n    --with github.com/caddyserver/nginx-adapter \\\n    --with github.com/caddy-dns/alidns\n\nFROM caddy:2.6.2\n\nCOPY --from=builder /usr/bin/caddy /usr/bin/caddy\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("如果使用 docker 的话，这种方法相对来说是最简单的，都是基于官方 docker 进行操作。")]),s._v(" "),t("h4",{attrs:{id:"方法四"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#方法四"}},[s._v("#")]),s._v(" 方法四")]),s._v(" "),t("p",[s._v("如果没有找到对应 DNS 提供商，也可以参考 "),t("a",{attrs:{href:"https://caddy.community/t/how-to-use-dns-provider-modules-in-caddy-2/8148#if-you-do-not-find-your-dns-provider-4",target:"_blank",rel:"noopener noreferrer"}},[s._v("这里"),t("OutboundLink")],1),s._v(" 提供的方案。（注意："),t("strong",[s._v("该方案未实际操作")]),s._v("）")]),s._v(" "),t("h3",{attrs:{id:"启用-dns-challenge"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启用-dns-challenge"}},[s._v("#")]),s._v(" 启用 DNS challenge")]),s._v(" "),t("p",[s._v("按照上述操作获取了一个带有 DNS 服务商插件的 Caddy 后只需在配置中启用 DNS challenge 即可。")]),s._v(" "),t("h4",{attrs:{id:"全局选项-对所有站点使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#全局选项-对所有站点使用"}},[s._v("#")]),s._v(" 全局选项（对所有站点使用）")]),s._v(" "),t("p",[s._v("在 Caddyfile 的顶部使用 "),t("a",{attrs:{href:"https://caddyserver.com/docs/caddyfile/options#acme-dns",target:"_blank",rel:"noopener noreferrer"}},[s._v("全局 acme_dns 选项"),t("OutboundLink")],1),s._v(" 进行配置：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    acme_dns <provider"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 例如")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    acme_dns alidns "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      access_key_id "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("env.ALIYUN_ACCESS_KEY_ID"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      access_key_secret "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("env.ALIYUN_ACCESS_KEY_SECRET"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("h4",{attrs:{id:"站点单独配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#站点单独配置"}},[s._v("#")]),s._v(" 站点单独配置")]),s._v(" "),t("p",[s._v("如果是为了指定站点配置，可以在站点的配置项中加上 "),t("a",{attrs:{href:"https://caddyserver.com/docs/caddyfile/directives/tls",target:"_blank",rel:"noopener noreferrer"}},[s._v("tls 指令"),t("OutboundLink")],1),s._v("：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[s._v("tls "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    dns <provider"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 例如")]),s._v("\ntls "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  dns alidns "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    access_key_id "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("env.ALIYUN_ACCESS_KEY_ID"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    access_key_secret "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("env.ALIYUN_ACCESS_KEY_SECRET"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("如果您的凭据在环境中，您也可以使用 "),t("code",[s._v("{env.*)")]),s._v(" 占位符。不同 DNS 服务商插件的配置项可能会有所区别，根据对应文档进行配置即可。")]),s._v(" "),t("h4",{attrs:{id:"jso-配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#jso-配置"}},[s._v("#")]),s._v(" JSO 配置")]),s._v(" "),t("p",[s._v("如果使用 JSON，请使用 "),t("a",{attrs:{href:"https://caddyserver.com/docs/json/apps/tls/automation/policies/issuers/acme/",target:"_blank",rel:"noopener noreferrer"}},[s._v("颁发者配置自动化策略 acme58"),t("OutboundLink")],1),s._v(" 设置：")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"module"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"acme"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"challenges"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"dns"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"provider"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"name"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"alidns"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"access_key_id"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"YOUR_ALIYUN_ACCESS_KEY_ID"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"access_key_secret"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"YOUR_ALIYUN_ACCESS_KEY_SECRET"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("h2",{attrs:{id:"禁用自动-https"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#禁用自动-https"}},[s._v("#")]),s._v(" 禁用自动 HTTPS")]),s._v(" "),t("p",[s._v("上面都是怎么自动配置 HTTPS 的，那如果就是想要一个 HTTP 站点呢，也是可以的：")]),s._v(" "),t("ul",[t("li",[s._v("在配置文件中明确禁用，配置 auto_https 属性\n"),t("ul",[t("li",[s._v("off：完全禁用")]),s._v(" "),t("li",[s._v("disable_redirects: 仅禁用 HTTP 到 HTTPS 重定向")]),s._v(" "),t("li",[s._v("disable_certs：仅禁用证书自动化")]),s._v(" "),t("li",[s._v("ignore_loaded_certs：即使手动加载证书，也执行证书自动化")])])]),s._v(" "),t("li",[s._v("不在配置中提供任何主机名或 IP 地址")]),s._v(" "),t("li",[s._v("专门监听 HTTP 端口")]),s._v(" "),t("li",[s._v("在配置中为网站地址加上前缀 "),t("code",[s._v("http://")])]),s._v(" "),t("li",[s._v("手动加载证书（除非设置了 ignore_loaded_certificates）")])]),s._v(" "),t("p",[s._v("对于简单的站点，用 Caddy 实现 HTTPS 的确是个不错的选择！")])])}),[],!1,null,null,null);a.default=e.exports}}]);